# Higresså­˜å‚¨è¿ç§»æŒ‡å—ï¼šä»local-storageåˆ°local-path

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›äº†å°†Higressç›‘æ§ç»„ä»¶çš„å­˜å‚¨ä»`local-storage`è¿ç§»åˆ°`local-path-provisioner`çš„å®Œæ•´æ–¹æ¡ˆã€‚

### è¿ç§»èƒŒæ™¯
- **å½“å‰çŠ¶æ€**ï¼šHigressç›‘æ§ç»„ä»¶ï¼ˆGrafanaã€Prometheusã€Lokiï¼‰ä½¿ç”¨æ‰‹åŠ¨åˆ›å»ºçš„`local-storage`ç±»å‹PV
- **ç›®æ ‡çŠ¶æ€**ï¼šè¿ç§»åˆ°`local-path`åŠ¨æ€å­˜å‚¨ä¾›åº”å™¨ï¼Œå®ç°è‡ªåŠ¨åŒ–å­˜å‚¨ç®¡ç†
- **è¿ç§»åŸå› **ï¼šæé«˜è¿ç»´æ•ˆç‡ã€ç»Ÿä¸€å­˜å‚¨æ–¹æ¡ˆã€æ”¯æŒåŠ¨æ€ä¾›åº”

## ğŸ” å½“å‰é›†ç¾¤å­˜å‚¨çŠ¶æ€

### éœ€è¦è¿ç§»çš„èµ„æº

| ç»„ä»¶ | PVCåç§° | PVåç§° | å­˜å‚¨å¤§å° | å½“å‰StorageClass | ç»‘å®šèŠ‚ç‚¹ |
|------|---------|--------|----------|------------------|----------|
| Grafana | `higress-console-grafana` | `higress-grafana-pv` | 1Gi | `local-storage` | debian-node1 |
| Prometheus | `higress-console-prometheus` | `higress-loki-pv` | 1Gi | `local-storage` | debian-node1 |
| Loki | `higress-console-loki` | `higress-prometheus-pv` | 1Gi | `local-storage` | debian-node1 |

### å·²ä½¿ç”¨local-pathçš„èµ„æºï¼ˆæ— éœ€è¿ç§»ï¼‰

| ç»„ä»¶ | PVCåç§° | å­˜å‚¨å¤§å° | StorageClass |
|------|---------|----------|--------------|
| Dify | `dify-storage-pvc` | 10Gi | `local-path` |
| Dify Plugin | `dify-plugin-storage-pvc` | 5Gi | `local-path` |

## ğŸš€ è¿ç§»æ–¹æ¡ˆ

### è¿ç§»ç­–ç•¥
é‡‡ç”¨**æ•°æ®å¤‡ä»½+é‡æ–°éƒ¨ç½²**ç­–ç•¥ï¼š
- âœ… æ“ä½œç®€å•ï¼Œé£é™©å¯æ§
- âœ… ç¡®ä¿è¿ç§»åé…ç½®å®Œå…¨æ­£ç¡®
- âš ï¸ ä¼šä¸¢å¤±å†å²ç›‘æ§æ•°æ®ï¼ˆå¯æ¥å—ï¼‰
- âš ï¸ çŸ­æš‚çš„ç›‘æ§æœåŠ¡ä¸­æ–­ï¼ˆ15-30åˆ†é’Ÿï¼‰

### è¿ç§»æ­¥éª¤æ¦‚è§ˆ
1. **ç¯å¢ƒæ£€æŸ¥** - éªŒè¯å‰ç½®æ¡ä»¶
2. **é…ç½®å¤‡ä»½** - å¤‡ä»½å½“å‰é…ç½®
3. **åœæ­¢æœåŠ¡** - ç¼©å®¹ç›‘æ§ç»„ä»¶
4. **æ¸…ç†èµ„æº** - åˆ é™¤æ—§PVCå’ŒPV
5. **åˆ›å»ºæ–°PVC** - ä½¿ç”¨local-path StorageClass
6. **æ¢å¤æœåŠ¡** - é‡å¯ç›‘æ§ç»„ä»¶
7. **éªŒè¯ç»“æœ** - ç¡®è®¤è¿ç§»æˆåŠŸ

## ğŸ“ æ–‡ä»¶è¯´æ˜

| æ–‡ä»¶å | ç”¨é€” | è¯´æ˜ |
|--------|------|------|
| `pre-migration-check.sh` | è¿ç§»å‰æ£€æŸ¥ | éªŒè¯ç¯å¢ƒæ˜¯å¦æ»¡è¶³è¿ç§»æ¡ä»¶ |
| `higress-storage-migration.sh` | ä¸»è¿ç§»è„šæœ¬ | æ‰§è¡Œå®Œæ•´çš„è¿ç§»æµç¨‹ |
| `post-migration-verify.sh` | è¿ç§»åéªŒè¯ | éªŒè¯è¿ç§»ç»“æœå’Œç³»ç»ŸçŠ¶æ€ |
| `STORAGE_MIGRATION_README.md` | æ–‡æ¡£ | å®Œæ•´çš„è¿ç§»æŒ‡å— |

## ğŸ› ï¸ æ‰§è¡Œæ­¥éª¤

### 1. è¿ç§»å‰æ£€æŸ¥
```bash
# èµ‹äºˆæ‰§è¡Œæƒé™
chmod +x pre-migration-check.sh

# æ‰§è¡Œç¯å¢ƒæ£€æŸ¥
./pre-migration-check.sh
```

**æ£€æŸ¥å†…å®¹ï¼š**
- Kubernetesé›†ç¾¤è¿æ¥
- local-path-provisionerçŠ¶æ€
- StorageClassé…ç½®
- å½“å‰å­˜å‚¨èµ„æºçŠ¶æ€
- Higressç›‘æ§ç»„ä»¶çŠ¶æ€
- èŠ‚ç‚¹å­˜å‚¨ç©ºé—´

### 2. æ‰§è¡Œè¿ç§»
```bash
# èµ‹äºˆæ‰§è¡Œæƒé™
chmod +x higress-storage-migration.sh

# æ‰§è¡Œè¿ç§»ï¼ˆéœ€è¦ç¡®è®¤ï¼‰
./higress-storage-migration.sh
```

**è¿ç§»è¿‡ç¨‹ï¼š**
- è‡ªåŠ¨å¤‡ä»½å½“å‰é…ç½®
- åœæ­¢ç›‘æ§æœåŠ¡ï¼ˆç¼©å®¹åˆ°0å‰¯æœ¬ï¼‰
- åˆ é™¤æ—§çš„PVCå’ŒPV
- åˆ›å»ºæ–°çš„local-pathç±»å‹PVC
- æ¢å¤ç›‘æ§æœåŠ¡
- éªŒè¯è¿ç§»ç»“æœ

### 3. è¿ç§»åéªŒè¯
```bash
# èµ‹äºˆæ‰§è¡Œæƒé™
chmod +x post-migration-verify.sh

# æ‰§è¡ŒéªŒè¯
./post-migration-verify.sh
```

**éªŒè¯å†…å®¹ï¼š**
- PVCçŠ¶æ€å’ŒStorageClass
- PVåˆ›å»ºå’Œç»‘å®šçŠ¶æ€
- Podè¿è¡ŒçŠ¶æ€
- å­˜å‚¨æŒ‚è½½æƒ…å†µ
- æœåŠ¡å¯è®¿é—®æ€§
- æ—§èµ„æºæ¸…ç†æƒ…å†µ

## âš ï¸ é£é™©è¯„ä¼°

| é£é™© | å½±å“ç¨‹åº¦ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|----------|------|----------|
| å†å²ç›‘æ§æ•°æ®ä¸¢å¤± | ä¸­ | 100% | å¯æ¥å—ï¼Œç›‘æ§æ•°æ®å¯é‡æ–°æ”¶é›† |
| ç›‘æ§æœåŠ¡çŸ­æš‚ä¸­æ–­ | ä½ | 100% | ä¸šåŠ¡æµé‡ä¸å—å½±å“ï¼Œä»…ç›‘æ§ä¸­æ–­ |
| PVCåˆ›å»ºå¤±è´¥ | é«˜ | ä½ | æå‰éªŒè¯local-path-provisioner |
| Podè°ƒåº¦å¤±è´¥ | ä¸­ | ä½ | ç¡®ä¿èŠ‚ç‚¹å­˜å‚¨ç©ºé—´å……è¶³ |
| è¿ç§»è„šæœ¬æ‰§è¡Œå¤±è´¥ | ä¸­ | ä½ | æä¾›é…ç½®å¤‡ä»½å’Œå›æ»šæ–¹æ¡ˆ |

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. local-path-provisioneræœªå°±ç»ª
```bash
# æ£€æŸ¥çŠ¶æ€
kubectl get deployment -n local-path-storage local-path-provisioner

# æŸ¥çœ‹æ—¥å¿—
kubectl logs -n local-path-storage deployment/local-path-provisioner
```

#### 2. PVCåˆ›å»ºå¤±è´¥
```bash
# æ£€æŸ¥PVCäº‹ä»¶
kubectl describe pvc -n higress-system <pvc-name>

# æ£€æŸ¥StorageClass
kubectl get storageclass local-path -o yaml
```

#### 3. Podå¯åŠ¨å¤±è´¥
```bash
# æŸ¥çœ‹PodçŠ¶æ€
kubectl get pods -n higress-system -l 'app in (higress-console-grafana,higress-console-prometheus,higress-console-loki)'

# æŸ¥çœ‹Podæ—¥å¿—
kubectl logs -n higress-system <pod-name>

# æŸ¥çœ‹Podäº‹ä»¶
kubectl describe pod -n higress-system <pod-name>
```

### å›æ»šæ–¹æ¡ˆ

å¦‚æœè¿ç§»å¤±è´¥ï¼Œå¯ä»¥ä½¿ç”¨å¤‡ä»½æ–‡ä»¶å›æ»šï¼š

```bash
# æ‰¾åˆ°å¤‡ä»½ç›®å½•
ls -la higress-migration-backup-*

# æ¢å¤PVé…ç½®
kubectl apply -f higress-migration-backup-*/pv-backup.yaml

# æ¢å¤PVCé…ç½®
kubectl apply -f higress-migration-backup-*/pvc-backup.yaml

# é‡å¯æœåŠ¡
kubectl rollout restart deployment -n higress-system higress-console-grafana
kubectl rollout restart deployment -n higress-system higress-console-prometheus
kubectl rollout restart deployment -n higress-system higress-console-loki
```

## ğŸ“Š è¿ç§»å‰åå¯¹æ¯”

### å­˜å‚¨é…ç½®å¯¹æ¯”

| ç‰¹æ€§ | è¿ç§»å‰ (local-storage) | è¿ç§»å (local-path) |
|------|----------------------|---------------------|
| **PVåˆ›å»ºæ–¹å¼** | æ‰‹åŠ¨åˆ›å»º | è‡ªåŠ¨åˆ›å»º |
| **å­˜å‚¨è·¯å¾„** | å›ºå®šè·¯å¾„ `/data/higress/*` | åŠ¨æ€è·¯å¾„ `/opt/local-path-provisioner/*` |
| **èŠ‚ç‚¹ç»‘å®š** | æ‰‹åŠ¨æŒ‡å®š `debian-node1` | è‡ªåŠ¨é€‰æ‹©èŠ‚ç‚¹ |
| **æ‰©å±•æ€§** | éœ€è¦æ‰‹åŠ¨æ“ä½œ | æ”¯æŒåŠ¨æ€æ‰©å±• |
| **è¿ç»´å¤æ‚åº¦** | é«˜ | ä½ |
| **ä¸€è‡´æ€§** | ä¸é›†ç¾¤å…¶ä»–åº”ç”¨ä¸ä¸€è‡´ | ä¸é›†ç¾¤æ ‡å‡†ä¸€è‡´ |

### é¢„æœŸæ”¶ç›Š

1. **è¿ç»´æ•ˆç‡æå‡**ï¼šæ— éœ€æ‰‹åŠ¨åˆ›å»ºPVï¼Œå‡å°‘è¿ç»´å·¥ä½œé‡
2. **é…ç½®æ ‡å‡†åŒ–**ï¼šä¸é›†ç¾¤å…¶ä»–åº”ç”¨ä½¿ç”¨ç»Ÿä¸€çš„å­˜å‚¨æ–¹æ¡ˆ
3. **æ‰©å±•æ€§å¢å¼º**ï¼šæ”¯æŒåŠ¨æ€å­˜å‚¨ä¾›åº”ï¼Œä¾¿äºåç»­æ‰©å±•
4. **æ•…éšœæ¢å¤ç®€åŒ–**ï¼šPVCåˆ é™¤é‡å»ºæ›´ç®€å•

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æ•°æ®ä¸¢å¤±**ï¼šè¿ç§»ä¼šæ¸…ç©ºå†å²ç›‘æ§æ•°æ®ï¼Œè¯·ç¡®è®¤å¯æ¥å—
2. **æœåŠ¡ä¸­æ–­**ï¼šç›‘æ§æœåŠ¡ä¼šçŸ­æš‚ä¸­æ–­ï¼Œä½†ä¸å½±å“ä¸šåŠ¡æµé‡
3. **æ‰§è¡Œæ—¶æœº**ï¼šå»ºè®®åœ¨ä¸šåŠ¡ä½å³°æœŸæ‰§è¡Œ
4. **å¤‡ä»½ä¿ç•™**ï¼šè¿ç§»æˆåŠŸåå»ºè®®ä¿ç•™å¤‡ä»½ä¸€æ®µæ—¶é—´
5. **éªŒè¯å……åˆ†**ï¼šè¿ç§»ååŠ¡å¿…æ‰§è¡Œå®Œæ•´éªŒè¯

## ğŸ¯ æ‰§è¡Œæ¸…å•

- [ ] é˜…è¯»å®Œæ•´è¿ç§»æ–‡æ¡£
- [ ] ç¡®è®¤è¿ç§»æ—¶é—´çª—å£
- [ ] æ‰§è¡Œè¿ç§»å‰æ£€æŸ¥
- [ ] å¤‡ä»½é‡è¦é…ç½®ï¼ˆè„šæœ¬è‡ªåŠ¨å®Œæˆï¼‰
- [ ] æ‰§è¡Œè¿ç§»è„šæœ¬
- [ ] æ‰§è¡Œè¿ç§»åéªŒè¯
- [ ] ç¡®è®¤ç›‘æ§åŠŸèƒ½æ­£å¸¸
- [ ] è§‚å¯Ÿç³»ç»Ÿç¨³å®šæ€§
- [ ] æ¸…ç†å¤‡ä»½æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰

## ğŸ“ æ”¯æŒ

å¦‚æœåœ¨è¿ç§»è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š

1. æŸ¥çœ‹è„šæœ¬è¾“å‡ºçš„é”™è¯¯ä¿¡æ¯
2. å‚è€ƒæ•…éšœæ’é™¤ç« èŠ‚
3. æ£€æŸ¥Kubernetesé›†ç¾¤æ—¥å¿—
4. å¿…è¦æ—¶ä½¿ç”¨å¤‡ä»½æ–‡ä»¶å›æ»š

---

**è¿ç§»å®Œæˆåï¼Œæ‚¨çš„Higressç›‘æ§å­˜å‚¨å°†å®Œå…¨ä½¿ç”¨local-path-provisionerï¼Œäº«å—æ›´é«˜æ•ˆçš„å­˜å‚¨ç®¡ç†ä½“éªŒï¼**